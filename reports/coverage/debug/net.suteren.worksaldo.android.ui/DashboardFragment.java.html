<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DashboardFragment.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">net.suteren.worksaldo.android.ui</a> &gt; <span class="el_source">DashboardFragment.java</span></div><h1>DashboardFragment.java</h1><pre class="source lang-java linenums">package net.suteren.worksaldo.android.ui;

import android.app.Fragment;
import android.app.LoaderManager;
import android.content.Context;
import android.content.CursorLoader;
import android.content.Loader;
import android.content.SharedPreferences;
import android.database.Cursor;
import android.os.Build;
import android.os.Bundle;
import android.support.v4.widget.SwipeRefreshLayout;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.AnimationUtils;
import android.widget.*;
import com.caverock.androidsvg.SVGImageView;
import net.suteren.worksaldo.IWorkEstimator;
import net.suteren.worksaldo.Period;
import net.suteren.worksaldo.StandardWorkEstimator;
import net.suteren.worksaldo.android.IRefreshable;
import net.suteren.worksaldo.android.IReloadable;
import net.suteren.worksaldo.android.R;
import org.joda.time.*;
import org.joda.time.format.*;

import java.io.IOException;
import java.io.Writer;
import java.util.Locale;
import java.util.Timer;
import java.util.TimerTask;

import static android.content.Context.MODE_PRIVATE;
import static net.suteren.worksaldo.StandardWorkEstimator.chunkOfWork;
import static net.suteren.worksaldo.android.provider.TogglCachedProvider.*;
import static net.suteren.worksaldo.android.ui.MainActivity.*;

/**
 * Fragment of main dashboard. Contains counters of work progress and list of days of work in actual period.
 */
<span class="nc" id="L43">public class DashboardFragment extends Fragment implements ISharedPreferencesProviderWithContext, IRefreshable,</span>
        IReloadable {

    /**
     * formatting duration of work in H:mm format with possible sign before hours.
     */
<span class="nc" id="L49">    public static final PeriodFormatter PERIOD_FORMATTER = new PeriodFormatterBuilder()</span>
            .printZeroIfSupported()
            .appendHours()
            .appendSeparator(&quot;:&quot;)
            .minimumPrintedDigits(2)
<span class="nc" id="L54">            .append(new PeriodPrinter() {</span>
                @Override
                public int calculatePrintedLength(ReadablePeriod period, Locale locale) {
<span class="nc" id="L57">                    return 2;</span>
                }

                @Override
                public int countFieldsToPrint(ReadablePeriod period, int stopAt, Locale locale) {
<span class="nc" id="L62">                    return 1;</span>
                }

                @Override
                public void printTo(StringBuffer buf, ReadablePeriod period, Locale locale) {
<span class="nc" id="L67">                    buf.append(String.format(&quot;%02d&quot;, Math.abs(period.get(DurationFieldType.minutes()))));</span>
<span class="nc" id="L68">                }</span>

                @Override
                public void printTo(Writer out, ReadablePeriod period, Locale locale) throws IOException {
<span class="nc" id="L72">                    StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L73">                    printTo(sb, period, locale);</span>
<span class="nc" id="L74">                    out.write(sb.toString());</span>
<span class="nc" id="L75">                }</span>
<span class="nc" id="L76">            }, new PeriodParser() {</span>
                @Override
                public int parseInto(ReadWritablePeriod period, String periodStr, int position, Locale locale) {
<span class="nc" id="L79">                    throw new UnsupportedOperationException();</span>
                }
            })
            .toFormatter();

<span class="nc" id="L84">    private LoaderManager.LoaderCallbacks&lt;Cursor&gt; DAYS_LOADER_CALLBACK = new AbstractDaysLoader(this) {</span>
        @Override
        public void onLoadFinished(Loader&lt;Cursor&gt; loader, Cursor data) {

<span class="nc" id="L88">            Cursor c = mAdapter.swapCursor(data);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            if (c != null) {</span>
<span class="nc" id="L90">                c.close();</span>
            }

<span class="nc" id="L93">            refreshSaldo(data);</span>
<span class="nc" id="L94">            Log.d(&quot;LoaderCallbacks&quot;, &quot;loaded &quot; + data.getCount() + &quot; items.&quot;);</span>
<span class="nc" id="L95">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;Cursor&gt; loader) {
<span class="nc" id="L99">            Log.d(&quot;LoaderCallbacks&quot;, &quot;loader reset&quot;);</span>
<span class="nc" id="L100">        }</span>
    };

<span class="nc" id="L103">    private LoaderManager.LoaderCallbacks&lt;Cursor&gt; RELOAD_CALLBACK = new AbstractDaysLoader(this) {</span>
        @Override
        public Loader&lt;Cursor&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L106">            LocalDate d = LocalDate.now();</span>
<span class="nc" id="L107">            String start = DATE_FORMAT.print(getPeriod().from(d));</span>
<span class="nc" id="L108">            String stop = DATE_FORMAT.print(getPeriod().to(d));</span>
<span class="nc" id="L109">            return new CursorLoader(getActivity(), RELOAD_URI, null, null, new String[]{start, stop}, null);</span>
        }

        @Override
        public void onLoadFinished(Loader&lt;Cursor&gt; loader, Cursor data) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (onReload != null) {</span>
<span class="nc" id="L115">                onReload.run();</span>
            }
<span class="nc" id="L117">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;Cursor&gt; loader) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (onReload != null) {</span>
<span class="nc" id="L122">                onReload.run();</span>
            }
<span class="nc" id="L124">        }</span>
    };
<span class="nc" id="L126">    private static final DateTimeFormatter WEEKDAY_FORMAT = DateTimeFormat.forPattern(&quot;E&quot;);</span>
    private static final String DAY_CLOSED_TIMESTAMP = &quot;day_closed_timestamp&quot;;
    private static final int MINUTE = 60000;
    private SimpleCursorAdapter mAdapter;
    private DayBinder dayBinder;
    private Runnable onReload;
    private ListView lv;
    private SwipeRefreshLayout refresh;
    private Timer refreshTimer;

    private Context getCtx() {
<span class="nc" id="L137">        return getContext();</span>
    }

    @Override
    public Context getContext() {
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; 23) {</span>
<span class="nc" id="L143">            return getActivity();</span>
        } else {
<span class="nc" id="L145">            return super.getContext();</span>
        }
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {

<span class="nc" id="L152">        final View rootView = inflater.inflate(R.layout.fragment_main, container, false);</span>

        // Prepare list of days and set adapter on it.
<span class="nc" id="L155">        lv = (ListView) rootView.findViewById(R.id.listing);</span>
<span class="nc" id="L156">        dayBinder = new DayBinder();</span>
<span class="nc" id="L157">        dayBinder.setMode(getRealWorkedTime());</span>
<span class="nc" id="L158">        mAdapter = new SimpleCursorAdapter(getCtx(), R.layout.row, null,</span>
                new String[]{DATE_NAME, DAY_START_NAME, DAY_END_NAME, DAY_TOTAL_NAME, DAY_SALDO_NAME},
                new int[]{R.id.date, R.id.from, R.id.to, R.id.total, R.id.saldo}, 0);
<span class="nc" id="L161">        mAdapter.setViewBinder(dayBinder);</span>
<span class="nc" id="L162">        lv.setAdapter(mAdapter);</span>

        // reload data from DB.
<span class="nc" id="L165">        getLoaderManager().initLoader(DAYS_LOADER, null, DAYS_LOADER_CALLBACK);</span>

        // set refresh action when swipe down list of days.
<span class="nc" id="L168">        refresh = (SwipeRefreshLayout) rootView.findViewById(R.id.refresh);</span>
<span class="nc" id="L169">        refresh.setOnRefreshListener(new SwipeRefreshLayout.OnRefreshListener() {</span>
            @Override
            public void onRefresh() {
<span class="nc" id="L172">                reload();</span>
<span class="nc" id="L173">                onReload(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L176">                        refresh.setRefreshing(false);</span>
<span class="nc" id="L177">                    }</span>
                });
<span class="nc" id="L179">            }</span>
        });

<span class="nc" id="L182">        rootView.findViewById(R.id.counters).setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L185">                switchClosedDay();</span>
<span class="nc" id="L186">            }</span>
        });

        // Set timer to refresh data every minute.
<span class="nc" id="L190">        setupRefreshTimer();</span>

<span class="nc" id="L192">        return rootView;</span>
    }

    void setupRefreshTimer() {
<span class="nc" id="L196">        refreshTimer = new Timer();</span>
<span class="nc" id="L197">        refreshTimer.schedule(new TimerTask() {</span>
            @Override
            public void run() {
<span class="nc" id="L200">                refresh();</span>
<span class="nc" id="L201">            }</span>
        }, MINUTE, MINUTE);
<span class="nc" id="L203">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L207">        super.onResume();</span>
<span class="nc" id="L208">        dayBinder.setMode(getRealWorkedTime());</span>
<span class="nc" id="L209">        refresh();</span>
<span class="nc" id="L210">        setupRefreshTimer();</span>
<span class="nc" id="L211">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L215">        refreshTimer.cancel();</span>
<span class="nc" id="L216">        super.onPause();</span>
<span class="nc" id="L217">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L221">        refreshTimer.cancel();</span>
<span class="nc" id="L222">        super.onDestroy();</span>
<span class="nc" id="L223">    }</span>

    private Period getPeriod() {
<span class="nc" id="L226">        return Period.valueOf(getSharedPreferences().getString(&quot;period&quot;, &quot;week&quot;).toUpperCase(Locale.ENGLISH));</span>
    }

    private void switchClosedDay() {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (isDayClosed()) {</span>
<span class="nc" id="L231">            openDay();</span>
        } else {
<span class="nc" id="L233">            closeDay();</span>
        }
<span class="nc bnc" id="L235" title="All 2 branches missed.">        Log.d(&quot;DashboardFragment&quot;, &quot;Day is now &quot; + (isDayClosed() ? &quot;closed&quot; : &quot;open&quot;));</span>
<span class="nc" id="L236">        refresh();</span>
<span class="nc" id="L237">    }</span>

    private void closeDay() {
<span class="nc" id="L240">        getSharedPreferences().edit().putLong(DAY_CLOSED_TIMESTAMP, DateTime.now().withTimeAtStartOfDay().plus(Days.days(1)).getMillis()).apply();</span>
<span class="nc" id="L241">    }</span>

    private void openDay() {
<span class="nc" id="L244">        getSharedPreferences().edit().putLong(DAY_CLOSED_TIMESTAMP, 0).apply();</span>
<span class="nc" id="L245">    }</span>

    private int getNumberColor(float currentSaldo) {
<span class="nc" id="L248">        final int[] intArray = getResources().getIntArray(R.array.numbercolors);</span>
<span class="nc" id="L249">        return intArray[(int) Math.signum(currentSaldo) + 1];</span>
    }

    @Override
    public SharedPreferences getSharedPreferences() {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (getActivity() instanceof ISharedPreferencesProvider) {</span>
<span class="nc" id="L255">            return ((ISharedPreferencesProvider) getActivity()).getSharedPreferences();</span>
        } else {
<span class="nc" id="L257">            return getActivity().getSharedPreferences(MAIN, MODE_PRIVATE);</span>
        }
    }

    /**
     * Causes reloading data from backend.
     */
    public void reload() {
<span class="nc" id="L265">        getLoaderManager().restartLoader(DAYS_UPDATER, null, RELOAD_CALLBACK);</span>
<span class="nc" id="L266">    }</span>

    /**
     * Sets action to be executed when reload is finished.
     *
     * @param action Action to execute when reload is finished.
     */
    public void onReload(Runnable action) {
<span class="nc" id="L274">        this.onReload = action;</span>
<span class="nc" id="L275">    }</span>

    @Override
    public void refresh() {
<span class="nc" id="L279">        Log.d(&quot;DashboardFragment&quot;, &quot;Refreshing&quot;);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (getActivity() != null) {</span>
<span class="nc" id="L281">            getActivity().runOnUiThread(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc" id="L284">                    getActivity().getContentResolver().notifyChange(TIMEENTRIES_URI, null);</span>
<span class="nc" id="L285">                    getLoaderManager().restartLoader(DAYS_LOADER, null, DAYS_LOADER_CALLBACK);</span>
<span class="nc" id="L286">                }</span>
            });
        }
<span class="nc" id="L289">    }</span>

    @Override
    public void onRefresh(Runnable action) {

<span class="nc" id="L294">    }</span>

<span class="nc" id="L296">    private class DayBinder implements SimpleCursorAdapter.ViewBinder {</span>

        private boolean realHours;

        @Override
        public boolean setViewValue(View view, Cursor cursor, int columnIndex) {

<span class="nc" id="L303">            TextView tv = (TextView) view;</span>

<span class="nc" id="L305">            LocalTime time = TIME_FORMAT.parseLocalTime(cursor.getString(2));</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (columnIndex == 2) { // time from</span>
<span class="nc" id="L307">                tv.setText(DateTimeFormat.shortTime().print(TIME_FORMAT.parseLocalTime(cursor.getString(2))));</span>
<span class="nc" id="L308">                return true;</span>
            }

<span class="nc" id="L311">            final LocalDate day = DATE_FORMAT.parseLocalDate(cursor.getString(1));</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (columnIndex == 1) { // date</span>
<span class="nc" id="L313">                tv.setText(String.format(&quot;%s %s&quot;, WEEKDAY_FORMAT.print(day), DateTimeFormat.mediumDate().print(day)));</span>
<span class="nc" id="L314">                return true;</span>
            }

<span class="nc" id="L317">            boolean isToday = day.isEqual(LocalDate.now());</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">            final LocalTime to = getEndTime(TIME_FORMAT.parseLocalTime(cursor.getString(3)), isToday &amp;&amp; !realHours);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if (columnIndex == 3) { // time to</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                tv.setText(to == null ? &quot;Ø&quot; : DateTimeFormat.shortTime().print(to));</span>
<span class="nc" id="L321">                return true;</span>
            }

            // prepare work estimator for both remaining columns: worked and bilance.
<span class="nc" id="L325">            IWorkEstimator we = new StandardWorkEstimator(getPeriod(), day.toLocalDateTime(to), Duration.standardHours(getTotalHours()));</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">            if (realHours) {</span>
<span class="nc" id="L327">                long duration = cursor.getLong(4);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                if (duration &gt; 0) {</span>
<span class="nc" id="L329">                    we.addHours(chunkOfWork(Duration.standardSeconds(duration), true));</span>
                }
<span class="nc" id="L331">            } else {</span>
<span class="nc" id="L332">                we.addHours(chunkOfWork(time, to, Duration.standardMinutes(getPause()), true));</span>
            }

<span class="nc bnc" id="L335" title="All 3 branches missed.">            switch (columnIndex) {</span>

                case 4: // worked
<span class="nc" id="L338">                    tv.setText(PERIOD_FORMATTER.print(we.getWorkedHoursToday().toPeriod()));</span>
<span class="nc" id="L339">                    return true;</span>

                case 5: // balance
<span class="nc" id="L342">                    final Duration saldoToday = we.getSaldoToday();</span>
<span class="nc" id="L343">                    tv.setText(PERIOD_FORMATTER.print(saldoToday.toPeriod()));</span>
<span class="nc" id="L344">                    tv.setTextColor(getNumberColor(saldoToday.getStandardSeconds()));</span>
<span class="nc" id="L345">                    return true;</span>
            }
<span class="nc" id="L347">            return false;</span>
        }

        public void setMode(boolean mode) {
<span class="nc" id="L351">            this.realHours = mode;</span>
<span class="nc" id="L352">        }</span>

    }

    private LocalTime getEndTime(LocalTime stop, boolean isToday) {
<span class="nc" id="L357">        final LocalTime now = LocalTime.now();</span>
<span class="nc bnc" id="L358" title="All 6 branches missed.">        return !isDayClosed() &amp;&amp; isToday &amp;&amp; now.isAfter(stop) ? now : stop;</span>
    }


    private boolean isDayClosed() {
<span class="nc" id="L363">        return new DateTime(getSharedPreferences().getLong(DAY_CLOSED_TIMESTAMP, 0)).isAfter(DateTime.now());</span>
    }

    private void refreshSaldo(Cursor data) {
<span class="nc" id="L367">        View rootView = getView();</span>
<span class="nc bnc" id="L368" title="All 4 branches missed.">        if (rootView == null || (rootView = getView().getRootView()) == null) {</span>
<span class="nc" id="L369">            return;</span>
        }

<span class="nc" id="L372">        StandardWorkEstimator we = getSaldoWorkEstimator(data);</span>

<span class="nc" id="L374">        Duration currentSaldo = we.getSaldo();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (isDayClosed()) {</span>
<span class="nc" id="L376">            currentSaldo = currentSaldo.plus(we.getSaldoToday());</span>
        }
<span class="nc" id="L378">        final Duration saldoToday = we.getSaldoToday();</span>
<span class="nc" id="L379">        final Duration remainingToday = we.getRemainingToday();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (isDayClosed()) {</span>
<span class="nc" id="L381">            currentSaldo.plus(we.getSaldoToday());</span>
        }

<span class="nc" id="L384">        TextView saldo = (TextView) rootView.findViewById(R.id.saldo);</span>
<span class="nc" id="L385">        saldo.setText(PERIOD_FORMATTER.print(currentSaldo.toPeriod()));</span>
<span class="nc" id="L386">        saldo.setTextColor(getNumberColor(currentSaldo.getStandardSeconds()));</span>

<span class="nc" id="L388">        TextView dailyAverage = (TextView) rootView.findViewById(R.id.dailyAverage);</span>
<span class="nc" id="L389">        dailyAverage.setText(PERIOD_FORMATTER.print(saldoToday.toPeriod()));</span>
<span class="nc" id="L390">        dailyAverage.setTextColor(getNumberColor(saldoToday.getStandardSeconds()));</span>

<span class="nc" id="L392">        TextView dailyTotal = (TextView) rootView.findViewById(R.id.dailyTotal);</span>
<span class="nc" id="L393">        dailyTotal.setText(PERIOD_FORMATTER.print(remainingToday.toPeriod()));</span>
<span class="nc" id="L394">        dailyTotal.setTextColor(getNumberColor(remainingToday.getStandardSeconds()));</span>

        @SuppressWarnings(&quot;deprecation&quot;)
<span class="nc" id="L397">        AnalogClock clock = (AnalogClock) rootView.findViewById(R.id.clock);</span>

<span class="nc" id="L399">        ImageView gears = (SVGImageView) rootView.findViewById(R.id.gears);</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (isDayClosed()) {</span>
<span class="nc" id="L402">            clock.setVisibility(View.GONE);</span>
<span class="nc" id="L403">            saldo.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L404">            gears.setVisibility(View.GONE);</span>
<span class="nc" id="L405">            gears.clearAnimation();</span>
        } else {
<span class="nc" id="L407">            clock.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L408">            saldo.setVisibility(View.GONE);</span>
<span class="nc" id="L409">            gears.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L410">            gears.startAnimation(AnimationUtils.loadAnimation(getActivity(), R.anim.rotate_gear));</span>
        }

<span class="nc" id="L413">        Log.d(&quot;DashboardFragment&quot;, &quot;Saldo reloaded&quot;);</span>
<span class="nc" id="L414">    }</span>

    private StandardWorkEstimator getSaldoWorkEstimator(Cursor data) {

<span class="nc" id="L418">        LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L419">        StandardWorkEstimator we = new StandardWorkEstimator(getPeriod(), now, Duration.standardHours(getTotalHours()));</span>

<span class="nc" id="L421">        data.moveToFirst();</span>

<span class="nc bnc" id="L423" title="All 2 branches missed.">        while (!data.isAfterLast()) {</span>
<span class="nc" id="L424">            final boolean isToday = LocalDate.now().isEqual(DATE_FORMAT.parseLocalDate(data.getString(1)));</span>

<span class="nc bnc" id="L426" title="All 2 branches missed.">            if (getRealWorkedTime()) {</span>
<span class="nc" id="L427">                long duration = data.getLong(4);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (duration &gt; 0) {</span>
<span class="nc" id="L429">                    we.addHours(chunkOfWork(Duration.standardSeconds(duration), isToday));</span>
                }
<span class="nc" id="L431">            } else {</span>
<span class="nc" id="L432">                we.addHours(chunkOfWork(</span>
                        TIME_FORMAT.parseLocalTime(data.getString(2)),
                        getEndTime(TIME_FORMAT.parseLocalTime(data.getString(3)), isToday),
                        Duration.standardMinutes(getPause()),
                        isToday));
            }
<span class="nc" id="L438">            data.moveToNext();</span>
<span class="nc" id="L439">        }</span>
<span class="nc" id="L440">        return we;</span>
    }

    private boolean getRealWorkedTime() {
<span class="nc" id="L444">        return getSharedPreferences().getBoolean(&quot;real_worked_time&quot;, false);</span>
    }

    /**
     * Return value from shared preferences.
     *
     * @return duration of mandatory work pause in minutes.
     */
    public int getPause() {
<span class="nc" id="L453">        return Integer.parseInt(getSharedPreferences().getString(&quot;pause&quot;, &quot;30&quot;));</span>
    }

    /**
     * Return value from shared preferences.
     *
     * @return demanded worked hours per period.
     */
    public int getTotalHours() {
<span class="nc" id="L462">        return Integer.parseInt(getSharedPreferences().getString(&quot;total_hours&quot;, &quot;40&quot;));</span>
    }

<span class="nc" id="L465">    private abstract class AbstractDaysLoader implements LoaderManager.LoaderCallbacks&lt;Cursor&gt; {</span>

        protected ISharedPreferencesProviderWithContext ctx;

<span class="nc" id="L469">        public AbstractDaysLoader(ISharedPreferencesProviderWithContext ctx) {</span>
<span class="nc" id="L470">            this.ctx = ctx;</span>
<span class="nc" id="L471">        }</span>

        @Override
        public Loader&lt;Cursor&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L475">            LocalDate d = LocalDate.now();</span>
<span class="nc" id="L476">            String start = DATE_FORMAT.print(getPeriod().from(d));</span>
<span class="nc" id="L477">            String stop = DATE_FORMAT.print(getPeriod().to(d));</span>
<span class="nc" id="L478">            Log.d(&quot;DashboardFragment&quot;, String.format(&quot;start: %s, stop: %s&quot;, start, stop));</span>
<span class="nc" id="L479">            return new CursorLoader(ctx.getContext(), TIMEENTRIES_URI,</span>
                    new String[]{DATE_COMPOSITE, DAY_START_COMPOSITE, DAY_END_COMPOSITE, DAY_TOTAL_COMPOSITE,
                            DAY_SALDO_COMPOSITE},
                    SELECT_WHERE,
                    new String[]{start, stop},
                    ORDER_BY);
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>