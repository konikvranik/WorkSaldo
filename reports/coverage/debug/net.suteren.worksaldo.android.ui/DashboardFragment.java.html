<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DashboardFragment.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">net.suteren.worksaldo.android.ui</a> &gt; <span class="el_source">DashboardFragment.java</span></div><h1>DashboardFragment.java</h1><pre class="source lang-java linenums">package net.suteren.worksaldo.android.ui;

import android.app.Fragment;
import android.app.LoaderManager;
import android.content.Context;
import android.content.CursorLoader;
import android.content.Loader;
import android.content.SharedPreferences;
import android.database.Cursor;
import android.os.Build;
import android.os.Bundle;
import android.support.v4.widget.SwipeRefreshLayout;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.AnimationUtils;
import android.widget.AnalogClock;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.SimpleCursorAdapter;
import android.widget.TextView;
import com.caverock.androidsvg.SVGImageView;
import net.suteren.worksaldo.IWorkEstimator;
import net.suteren.worksaldo.Period;
import net.suteren.worksaldo.StandardWorkEstimator;
import net.suteren.worksaldo.android.IRefreshable;
import net.suteren.worksaldo.android.IReloadable;
import net.suteren.worksaldo.android.R;
import org.joda.time.DateTime;
import org.joda.time.Days;
import org.joda.time.Duration;
import org.joda.time.DurationFieldType;
import org.joda.time.LocalDate;
import org.joda.time.LocalDateTime;
import org.joda.time.LocalTime;
import org.joda.time.ReadWritablePeriod;
import org.joda.time.ReadablePeriod;
import org.joda.time.format.DateTimeFormat;
import org.joda.time.format.DateTimeFormatter;
import org.joda.time.format.PeriodFormatter;
import org.joda.time.format.PeriodFormatterBuilder;
import org.joda.time.format.PeriodParser;
import org.joda.time.format.PeriodPrinter;

import java.io.IOException;
import java.io.Writer;
import java.util.Locale;
import java.util.Timer;
import java.util.TimerTask;

import static android.content.Context.MODE_PRIVATE;
import static net.suteren.worksaldo.StandardWorkEstimator.chunkOfWork;
import static net.suteren.worksaldo.android.provider.TogglCachedProvider.*;
import static net.suteren.worksaldo.android.ui.MainActivity.*;

/**
 * Fragment of main dashboard. Contains counters of work progress and list of days of work in actual period.
 */
<span class="nc" id="L60">public class DashboardFragment extends Fragment implements ISharedPreferencesProviderWithContext, IRefreshable,</span>
        IReloadable {

    /**
     * formatting duration of work in H:mm format with possible sign before hours.
     */
<span class="nc" id="L66">    public static final PeriodFormatter PERIOD_FORMATTER = new PeriodFormatterBuilder()</span>
            .printZeroIfSupported()
            .appendHours()
            .appendSeparator(&quot;:&quot;)
            .minimumPrintedDigits(2)
<span class="nc" id="L71">            .append(new PeriodPrinter() {</span>
                @Override
                public int calculatePrintedLength(ReadablePeriod period, Locale locale) {
<span class="nc" id="L74">                    return 2;</span>
                }

                @Override
                public int countFieldsToPrint(ReadablePeriod period, int stopAt, Locale locale) {
<span class="nc" id="L79">                    return 1;</span>
                }

                @Override
                public void printTo(StringBuffer buf, ReadablePeriod period, Locale locale) {
<span class="nc" id="L84">                    buf.append(String.format(&quot;%02d&quot;, Math.abs(period.get(DurationFieldType.minutes()))));</span>
<span class="nc" id="L85">                }</span>

                @Override
                public void printTo(Writer out, ReadablePeriod period, Locale locale) throws IOException {
<span class="nc" id="L89">                    StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L90">                    printTo(sb, period, locale);</span>
<span class="nc" id="L91">                    out.write(sb.toString());</span>
<span class="nc" id="L92">                }</span>
<span class="nc" id="L93">            }, new PeriodParser() {</span>
                @Override
                public int parseInto(ReadWritablePeriod period, String periodStr, int position, Locale locale) {
<span class="nc" id="L96">                    throw new UnsupportedOperationException();</span>
                }
            })
            .toFormatter();

<span class="nc" id="L101">    private LoaderManager.LoaderCallbacks&lt;Cursor&gt; DAYS_LOADER_CALLBACK = new AbstractDaysLoader(this) {</span>
        @Override
        public void onLoadFinished(Loader&lt;Cursor&gt; loader, Cursor data) {

<span class="nc" id="L105">            Cursor c = mAdapter.swapCursor(data);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (c != null) {</span>
<span class="nc" id="L107">                c.close();</span>
            }

<span class="nc" id="L110">            refreshSaldo(data);</span>
<span class="nc" id="L111">            Log.d(&quot;LoaderCallbacks&quot;, &quot;loaded &quot; + data.getCount() + &quot; items.&quot;);</span>
<span class="nc" id="L112">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;Cursor&gt; loader) {
<span class="nc" id="L116">            Log.d(&quot;LoaderCallbacks&quot;, &quot;loader reset&quot;);</span>
<span class="nc" id="L117">        }</span>
    };

<span class="nc" id="L120">    private LoaderManager.LoaderCallbacks&lt;Cursor&gt; RELOAD_CALLBACK = new AbstractDaysLoader(this) {</span>
        @Override
        public Loader&lt;Cursor&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L123">            LocalDate d = LocalDate.now();</span>
<span class="nc" id="L124">            String start = DATE_FORMAT.print(getPeriod().from(d));</span>
<span class="nc" id="L125">            String stop = DATE_FORMAT.print(getPeriod().to(d));</span>
<span class="nc" id="L126">            return new CursorLoader(getActivity(), RELOAD_URI, null, null, new String[]{start, stop}, null);</span>
        }

        @Override
        public void onLoadFinished(Loader&lt;Cursor&gt; loader, Cursor data) {
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (onReload != null) {</span>
<span class="nc" id="L132">                onReload.run();</span>
            }
<span class="nc" id="L134">        }</span>

        @Override
        public void onLoaderReset(Loader&lt;Cursor&gt; loader) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (onReload != null) {</span>
<span class="nc" id="L139">                onReload.run();</span>
            }
<span class="nc" id="L141">        }</span>
    };
<span class="nc" id="L143">    private static final DateTimeFormatter WEEKDAY_FORMAT = DateTimeFormat.forPattern(&quot;E&quot;);</span>
    private static final String DAY_CLOSED_TIMESTAMP = &quot;day_closed_timestamp&quot;;
    private static final int MINUTE = 60000;
    private SimpleCursorAdapter mAdapter;
    private DayBinder dayBinder;
    private Runnable onReload;
    private ListView lv;
    private SwipeRefreshLayout refresh;
    private Timer refreshTimer;

    private Context getCtx() {
<span class="nc" id="L154">        return getContext();</span>
    }

    @Override
    public Context getContext() {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; 23) {</span>
<span class="nc" id="L160">            return getActivity();</span>
        } else {
<span class="nc" id="L162">            return super.getContext();</span>
        }
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {

<span class="nc" id="L169">        final View rootView = inflater.inflate(R.layout.fragment_main, container, false);</span>

        // Prepare list of days and set adapter on it.
<span class="nc" id="L172">        lv = (ListView) rootView.findViewById(R.id.listing);</span>
<span class="nc" id="L173">        dayBinder = new DayBinder();</span>
<span class="nc" id="L174">        dayBinder.setMode(getRealWorkedTime());</span>
<span class="nc" id="L175">        mAdapter = new SimpleCursorAdapter(getCtx(), R.layout.row, null,</span>
                new String[]{DATE_NAME, DAY_START_NAME, DAY_END_NAME, DAY_TOTAL_NAME, DAY_SALDO_NAME},
                new int[]{R.id.date, R.id.from, R.id.to, R.id.total, R.id.saldo}, 0);
<span class="nc" id="L178">        mAdapter.setViewBinder(dayBinder);</span>
<span class="nc" id="L179">        lv.setAdapter(mAdapter);</span>

        // reload data from DB.
<span class="nc" id="L182">        getLoaderManager().initLoader(DAYS_LOADER, null, DAYS_LOADER_CALLBACK);</span>

        // set refresh action when swipe down list of days.
<span class="nc" id="L185">        refresh = (SwipeRefreshLayout) rootView.findViewById(R.id.refresh);</span>
<span class="nc" id="L186">        refresh.setOnRefreshListener(new SwipeRefreshLayout.OnRefreshListener() {</span>
            @Override
            public void onRefresh() {
<span class="nc" id="L189">                reload();</span>
<span class="nc" id="L190">                onReload(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L193">                        refresh.setRefreshing(false);</span>
<span class="nc" id="L194">                    }</span>
                });
<span class="nc" id="L196">            }</span>
        });

<span class="nc" id="L199">        rootView.findViewById(R.id.counters).setOnClickListener(new View.OnClickListener() {</span>
            @Override
            public void onClick(View v) {
<span class="nc" id="L202">                switchClosedDay();</span>
<span class="nc" id="L203">            }</span>
        });

        // Set timer to refresh data every minute.
<span class="nc" id="L207">        setupRefreshTimer();</span>

<span class="nc" id="L209">        return rootView;</span>
    }

    void setupRefreshTimer() {
<span class="nc" id="L213">        refreshTimer = new Timer();</span>
<span class="nc" id="L214">        refreshTimer.schedule(new TimerTask() {</span>
            @Override
            public void run() {
<span class="nc" id="L217">                refresh();</span>
<span class="nc" id="L218">            }</span>
        }, MINUTE, MINUTE);
<span class="nc" id="L220">    }</span>

    @Override
    public void onResume() {
<span class="nc" id="L224">        super.onResume();</span>
<span class="nc" id="L225">        dayBinder.setMode(getRealWorkedTime());</span>
<span class="nc" id="L226">        refresh();</span>
<span class="nc" id="L227">        setupRefreshTimer();</span>
<span class="nc" id="L228">    }</span>

    @Override
    public void onPause() {
<span class="nc" id="L232">        refreshTimer.cancel();</span>
<span class="nc" id="L233">        super.onPause();</span>
<span class="nc" id="L234">    }</span>

    @Override
    public void onDestroy() {
<span class="nc" id="L238">        refreshTimer.cancel();</span>
<span class="nc" id="L239">        super.onDestroy();</span>
<span class="nc" id="L240">    }</span>

    private Period getPeriod() {
<span class="nc" id="L243">        return Period.valueOf(getSharedPreferences().getString(&quot;period&quot;, &quot;week&quot;).toUpperCase(Locale.ENGLISH));</span>
    }

    private void switchClosedDay() {
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (isDayClosed()) {</span>
<span class="nc" id="L248">            openDay();</span>
        } else {
<span class="nc" id="L250">            closeDay();</span>
        }
<span class="nc bnc" id="L252" title="All 2 branches missed.">        Log.d(&quot;DashboardFragment&quot;, &quot;Day is now &quot; + (isDayClosed() ? &quot;closed&quot; : &quot;open&quot;));</span>
<span class="nc" id="L253">        refresh();</span>
<span class="nc" id="L254">    }</span>

    private void closeDay() {
<span class="nc" id="L257">        getSharedPreferences().edit().putLong(DAY_CLOSED_TIMESTAMP, DateTime.now().withTimeAtStartOfDay().plus(Days</span>
                .days(1)).getMillis()).apply();
<span class="nc" id="L259">    }</span>

    private void openDay() {
<span class="nc" id="L262">        getSharedPreferences().edit().putLong(DAY_CLOSED_TIMESTAMP, 0).apply();</span>
<span class="nc" id="L263">    }</span>

    private int getNumberColor(float currentSaldo) {
<span class="nc" id="L266">        final int[] intArray = getResources().getIntArray(R.array.numbercolors);</span>
<span class="nc" id="L267">        return intArray[(int) Math.signum(currentSaldo) + 1];</span>
    }

    @Override
    public SharedPreferences getSharedPreferences() {
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (getActivity() instanceof ISharedPreferencesProvider) {</span>
<span class="nc" id="L273">            return ((ISharedPreferencesProvider) getActivity()).getSharedPreferences();</span>
        } else {
<span class="nc" id="L275">            return getActivity().getSharedPreferences(MAIN, MODE_PRIVATE);</span>
        }
    }

    /**
     * Causes reloading data from backend.
     */
    public void reload() {
<span class="nc" id="L283">        getLoaderManager().restartLoader(DAYS_UPDATER, null, RELOAD_CALLBACK);</span>
<span class="nc" id="L284">    }</span>

    /**
     * Sets action to be executed when reload is finished.
     *
     * @param action Action to execute when reload is finished.
     */
    public void onReload(Runnable action) {
<span class="nc" id="L292">        this.onReload = action;</span>
<span class="nc" id="L293">    }</span>

    @Override
    public void refresh() {
<span class="nc" id="L297">        Log.d(&quot;DashboardFragment&quot;, &quot;Refreshing&quot;);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (getActivity() != null) {</span>
<span class="nc" id="L299">            getActivity().runOnUiThread(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc" id="L302">                    getActivity().getContentResolver().notifyChange(TIMEENTRIES_URI, null);</span>
<span class="nc" id="L303">                    getLoaderManager().restartLoader(DAYS_LOADER, null, DAYS_LOADER_CALLBACK);</span>
<span class="nc" id="L304">                }</span>
            });
        }
<span class="nc" id="L307">    }</span>

    @Override
    public void onRefresh(Runnable action) {

<span class="nc" id="L312">    }</span>

<span class="nc" id="L314">    private class DayBinder implements SimpleCursorAdapter.ViewBinder {</span>

        private boolean realHours;

        @Override
        public boolean setViewValue(View view, Cursor cursor, int columnIndex) {

<span class="nc" id="L321">            TextView tv = (TextView) view;</span>

<span class="nc" id="L323">            LocalTime time = TIME_FORMAT.parseLocalTime(cursor.getString(2));</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (columnIndex == 2) { // time from</span>
<span class="nc" id="L325">                tv.setText(DateTimeFormat.shortTime().print(TIME_FORMAT.parseLocalTime(cursor.getString(2))));</span>
<span class="nc" id="L326">                return true;</span>
            }

<span class="nc" id="L329">            final LocalDate day = DATE_FORMAT.parseLocalDate(cursor.getString(1));</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (columnIndex == 1) { // date</span>
<span class="nc" id="L331">                tv.setText(String.format(&quot;%s %s&quot;, WEEKDAY_FORMAT.print(day), DateTimeFormat.mediumDate().print(day)));</span>
<span class="nc" id="L332">                return true;</span>
            }

<span class="nc" id="L335">            boolean isToday = day.isEqual(LocalDate.now());</span>
<span class="nc bnc" id="L336" title="All 4 branches missed.">            final LocalTime to = getEndTime(TIME_FORMAT.parseLocalTime(cursor.getString(3)), isToday &amp;&amp; !realHours);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (columnIndex == 3) { // time to</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                tv.setText(to == null ? &quot;Ã˜&quot; : DateTimeFormat.shortTime().print(to));</span>
<span class="nc" id="L339">                return true;</span>
            }

            // prepare work estimator for both remaining columns: worked and bilance.
<span class="nc" id="L343">            IWorkEstimator we = new StandardWorkEstimator(getPeriod(), day.toLocalDateTime(to), Duration</span>
                    .standardHours(getTotalHours()));
<span class="nc bnc" id="L345" title="All 2 branches missed.">            if (realHours) {</span>
<span class="nc" id="L346">                long duration = cursor.getLong(4);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                if (duration &gt; 0) {</span>
<span class="nc" id="L348">                    we.addHours(chunkOfWork(Duration.standardSeconds(duration), true));</span>
                }
<span class="nc" id="L350">            } else {</span>
<span class="nc" id="L351">                we.addHours(chunkOfWork(time, to, Duration.standardMinutes(getPause()), true));</span>
            }

<span class="nc bnc" id="L354" title="All 3 branches missed.">            switch (columnIndex) {</span>

                case 4: // worked
<span class="nc" id="L357">                    tv.setText(PERIOD_FORMATTER.print(we.getWorkedHoursToday().toPeriod()));</span>
<span class="nc" id="L358">                    return true;</span>

                case 5: // balance
<span class="nc" id="L361">                    final Duration saldoToday = we.getSaldoToday();</span>
<span class="nc" id="L362">                    tv.setText(PERIOD_FORMATTER.print(saldoToday.toPeriod()));</span>
<span class="nc" id="L363">                    tv.setTextColor(getNumberColor(saldoToday.getStandardSeconds()));</span>
<span class="nc" id="L364">                    return true;</span>
            }
<span class="nc" id="L366">            return false;</span>
        }

        public void setMode(boolean mode) {
<span class="nc" id="L370">            this.realHours = mode;</span>
<span class="nc" id="L371">        }</span>

    }

    private LocalTime getEndTime(LocalTime stop, boolean isToday) {
<span class="nc" id="L376">        final LocalTime now = LocalTime.now();</span>
<span class="nc bnc" id="L377" title="All 6 branches missed.">        return !isDayClosed() &amp;&amp; isToday &amp;&amp; now.isAfter(stop) ? now : stop;</span>
    }


    private boolean isDayClosed() {
<span class="nc" id="L382">        return new DateTime(getSharedPreferences().getLong(DAY_CLOSED_TIMESTAMP, 0)).isAfter(DateTime.now());</span>
    }

    private void refreshSaldo(Cursor data) {
<span class="nc" id="L386">        View rootView = getView();</span>
<span class="nc bnc" id="L387" title="All 4 branches missed.">        if (rootView == null || (rootView = getView().getRootView()) == null) {</span>
<span class="nc" id="L388">            return;</span>
        }

<span class="nc" id="L391">        StandardWorkEstimator we = getSaldoWorkEstimator(data);</span>

<span class="nc" id="L393">        TextView mainCounter = (TextView) rootView.findViewById(R.id.saldo);</span>
<span class="nc" id="L394">        TextView upperCounter = (TextView) rootView.findViewById(R.id.upperCounter);</span>
<span class="nc" id="L395">        TextView lowerCounter = (TextView) rootView.findViewById(R.id.lowerCounter);</span>
        @SuppressWarnings(&quot;deprecation&quot;)
<span class="nc" id="L397">        AnalogClock clock = (AnalogClock) rootView.findViewById(R.id.clock);</span>
<span class="nc" id="L398">        ImageView gears = (SVGImageView) rootView.findViewById(R.id.gears);</span>

<span class="nc bnc" id="L400" title="All 2 branches missed.">        if (isDayClosed()) {</span>
<span class="nc" id="L401">            mainCounter.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L402">            clock.setVisibility(View.GONE);</span>
<span class="nc" id="L403">            gears.setVisibility(View.GONE);</span>
<span class="nc" id="L404">            gears.clearAnimation();</span>

            // main counter
<span class="nc" id="L407">            Duration currentSaldo = we.getSaldo().plus(we.getSaldoToday());</span>
<span class="nc" id="L408">            mainCounter.setTextColor(getNumberColor(currentSaldo.getStandardSeconds()));</span>
<span class="nc" id="L409">            mainCounter.setText(PERIOD_FORMATTER.print(currentSaldo.toPeriod()));</span>

            // upper counter
<span class="nc" id="L412">            resetColor(lowerCounter);</span>
<span class="nc" id="L413">            upperCounter.setText(PERIOD_FORMATTER.print(we.getWorkedHours().toPeriod()));</span>

            // lower counter
<span class="nc" id="L416">            lowerCounter.setText(PERIOD_FORMATTER.print(we.getRemainingTotal().toPeriod()));</span>
<span class="nc" id="L417">        } else {</span>
<span class="nc" id="L418">            mainCounter.setVisibility(View.GONE);</span>
<span class="nc" id="L419">            clock.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L420">            gears.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L421">            gears.startAnimation(AnimationUtils.loadAnimation(getActivity(), R.anim.rotate_gear));</span>

            // upper counter
<span class="nc" id="L424">            upperCounter.setTextColor(getNumberColor(we.getSaldoToday().getStandardSeconds()));</span>
<span class="nc" id="L425">            upperCounter.setText(PERIOD_FORMATTER.print(we.getSaldoToday().toPeriod()));</span>

            // lower counter
<span class="nc" id="L428">            Duration lowerCounterValue = we.getSaldo().plus(we.getSaldoToday());</span>
<span class="nc" id="L429">            upperCounter.setTextColor(getNumberColor(lowerCounterValue.getStandardSeconds()));</span>
<span class="nc" id="L430">            lowerCounter.setText(PERIOD_FORMATTER.print(lowerCounterValue.toPeriod()));</span>
        }

<span class="nc" id="L433">        Log.d(&quot;DashboardFragment&quot;, &quot;Saldo reloaded&quot;);</span>
<span class="nc" id="L434">    }</span>

    private void resetColor(TextView lowerCounter) {
<span class="nc bnc" id="L437" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; 23) {</span>
<span class="nc" id="L438">            lowerCounter.setTextColor(getResources().getColor(android.R.color.primary_text_dark));</span>
        } else {
<span class="nc" id="L440">            lowerCounter.setTextColor(getCtx().getColor(android.R.color.primary_text_dark));</span>
        }
<span class="nc" id="L442">    }</span>

    private StandardWorkEstimator getSaldoWorkEstimator(Cursor data) {

<span class="nc" id="L446">        LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L447">        StandardWorkEstimator we = new StandardWorkEstimator(getPeriod(), now, Duration.standardHours(getTotalHours()));</span>

<span class="nc" id="L449">        data.moveToFirst();</span>

<span class="nc bnc" id="L451" title="All 2 branches missed.">        while (!data.isAfterLast()) {</span>
<span class="nc" id="L452">            final boolean isToday = LocalDate.now().isEqual(DATE_FORMAT.parseLocalDate(data.getString(1)));</span>

<span class="nc bnc" id="L454" title="All 2 branches missed.">            if (getRealWorkedTime()) {</span>
<span class="nc" id="L455">                long duration = data.getLong(4);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                if (duration &gt; 0) {</span>
<span class="nc" id="L457">                    we.addHours(chunkOfWork(Duration.standardSeconds(duration), isToday));</span>
                }
<span class="nc" id="L459">            } else {</span>
<span class="nc" id="L460">                we.addHours(chunkOfWork(</span>
                        TIME_FORMAT.parseLocalTime(data.getString(2)),
                        getEndTime(TIME_FORMAT.parseLocalTime(data.getString(3)), isToday),
                        Duration.standardMinutes(getPause()),
                        isToday));
            }
<span class="nc" id="L466">            data.moveToNext();</span>
<span class="nc" id="L467">        }</span>
<span class="nc" id="L468">        return we;</span>
    }

    private boolean getRealWorkedTime() {
<span class="nc" id="L472">        return getSharedPreferences().getBoolean(&quot;real_worked_time&quot;, false);</span>
    }

    /**
     * Return value from shared preferences.
     *
     * @return duration of mandatory work pause in minutes.
     */
    public int getPause() {
<span class="nc" id="L481">        return Integer.parseInt(getSharedPreferences().getString(&quot;pause&quot;, &quot;30&quot;));</span>
    }

    /**
     * Return value from shared preferences.
     *
     * @return demanded worked hours per period.
     */
    public int getTotalHours() {
<span class="nc" id="L490">        return Integer.parseInt(getSharedPreferences().getString(&quot;total_hours&quot;, &quot;40&quot;));</span>
    }

<span class="nc" id="L493">    private abstract class AbstractDaysLoader implements LoaderManager.LoaderCallbacks&lt;Cursor&gt; {</span>

        protected ISharedPreferencesProviderWithContext ctx;

<span class="nc" id="L497">        public AbstractDaysLoader(ISharedPreferencesProviderWithContext ctx) {</span>
<span class="nc" id="L498">            this.ctx = ctx;</span>
<span class="nc" id="L499">        }</span>

        @Override
        public Loader&lt;Cursor&gt; onCreateLoader(int id, Bundle args) {
<span class="nc" id="L503">            LocalDate d = LocalDate.now();</span>
<span class="nc" id="L504">            String start = DATE_FORMAT.print(getPeriod().from(d));</span>
<span class="nc" id="L505">            String stop = DATE_FORMAT.print(getPeriod().to(d));</span>
<span class="nc" id="L506">            Log.d(&quot;DashboardFragment&quot;, String.format(&quot;start: %s, stop: %s&quot;, start, stop));</span>
<span class="nc" id="L507">            return new CursorLoader(ctx.getContext(), TIMEENTRIES_URI,</span>
                    new String[]{DATE_COMPOSITE, DAY_START_COMPOSITE, DAY_END_COMPOSITE, DAY_TOTAL_COMPOSITE,
                            DAY_SALDO_COMPOSITE},
                    SELECT_WHERE,
                    new String[]{start, stop},
                    ORDER_BY);
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>